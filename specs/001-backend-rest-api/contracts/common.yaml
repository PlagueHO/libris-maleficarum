openapi: 3.0.3
info:
  title: Libris Maleficarum - Common Schemas
  description: Shared schemas, responses, and parameters used across all API endpoints
  version: 1.0.0

components:
  schemas:
    # ==========================================
    # Generic Response Wrappers
    # ==========================================
    
    ApiResponse:
      type: object
      description: Standard API response wrapper containing data and metadata
      required:
        - data
        - meta
      properties:
        data:
          description: The actual response data (type varies by endpoint)
        meta:
          $ref: '#/components/schemas/ResponseMeta'
      example:
        data: 
          id: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
          name: "Example Data"
        meta:
          requestId: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
          timestamp: "2026-01-03T10:30:00Z"
    
    ResponseMeta:
      type: object
      description: Metadata included in all API responses
      required:
        - requestId
        - timestamp
      properties:
        requestId:
          type: string
          format: uuid
          description: Unique identifier for this request (for tracing and support)
          example: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
        timestamp:
          type: string
          format: date-time
          description: Server timestamp when response was generated (ISO 8601)
          example: "2026-01-03T10:30:00Z"
    
    PaginatedApiResponse:
      type: object
      description: API response wrapper for paginated list results
      required:
        - data
        - meta
        - pagination
      properties:
        data:
          type: array
          description: Array of items for current page
          items: {}
        meta:
          $ref: '#/components/schemas/ResponseMeta'
        pagination:
          $ref: '#/components/schemas/PaginationResponse'
    
    PaginationResponse:
      type: object
      description: Pagination metadata for list endpoints
      required:
        - cursor
        - limit
        - hasMore
      properties:
        cursor:
          type: string
          nullable: true
          description: Opaque cursor for next page (null if no more pages)
          example: "eyJpZCI6IjNmYTg1ZjY0LTU3MTctNDU2Mi1iM2ZjLTJjOTYzZjY2YWZhNiJ9"
        limit:
          type: integer
          description: Number of items in current page
          minimum: 1
          maximum: 200
          example: 50
        hasMore:
          type: boolean
          description: Whether more pages are available
          example: true
    
    # ==========================================
    # Error Response Schemas
    # ==========================================
    
    ErrorResponse:
      type: object
      description: Standard error response format
      required:
        - error
        - meta
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Machine-readable error code
              example: "VALIDATION_ERROR"
            message:
              type: string
              description: Human-readable error message
              example: "One or more validation errors occurred"
            details:
              type: array
              description: Field-level validation errors (optional, for 400 Bad Request)
              items:
                $ref: '#/components/schemas/ValidationError'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    
    ValidationError:
      type: object
      description: Field-level validation error detail
      required:
        - field
        - message
      properties:
        field:
          type: string
          description: Name of the field that failed validation
          example: "name"
        message:
          type: string
          description: Validation error message for this field
          example: "Name must be between 1 and 100 characters"
    
    # ==========================================
    # Common Query Parameters
    # ==========================================
    
    LimitParameter:
      name: limit
      in: query
      description: Maximum number of items to return per page
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 50
      example: 50
    
    CursorParameter:
      name: cursor
      in: query
      description: Opaque cursor from previous page's pagination.cursor field
      required: false
      schema:
        type: string
        nullable: true
      example: "eyJpZCI6IjNmYTg1ZjY0LTU3MTctNDU2Mi1iM2ZjLTJjOTYzZjY2YWZhNiJ9"
    
    # ==========================================
    # Common Path Parameters
    # ==========================================
    
    WorldIdParameter:
      name: worldId
      in: path
      description: Unique identifier for the world
      required: true
      schema:
        type: string
        format: uuid
      example: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
    
    EntityIdParameter:
      name: entityId
      in: path
      description: Unique identifier for the entity
      required: true
      schema:
        type: string
        format: uuid
      example: "7b8c9d0e-1234-5678-9abc-def012345678"
    
    AssetIdParameter:
      name: assetId
      in: path
      description: Unique identifier for the asset
      required: true
      schema:
        type: string
        format: uuid
      example: "9e8f7g6h-5432-1098-ijkl-mnop12345678"
    
    # ==========================================
    # Common Headers
    # ==========================================
    
    IfMatchHeader:
      name: If-Match
      in: header
      description: ETag value from previous GET response for optimistic concurrency control (optional)
      required: false
      schema:
        type: string
      example: '"686897696a7c876b7e"'
    
    ETagHeader:
      name: ETag
      description: Entity version identifier for optimistic concurrency control
      schema:
        type: string
      example: '"686897696a7c876b7e"'
    
  # ==========================================
  # Standard Error Responses
  # ==========================================
  
  responses:
    BadRequest:
      description: Bad Request - Invalid input or validation errors
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "VALIDATION_ERROR"
              message: "One or more validation errors occurred"
              details:
                - field: "name"
                  message: "Name is required and must be between 1 and 100 characters"
                - field: "entityType"
                  message: "EntityType must be a valid value"
            meta:
              requestId: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
              timestamp: "2026-01-03T10:30:00Z"
    
    Unauthorized:
      description: Unauthorized - Missing or invalid authentication token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "UNAUTHORIZED"
              message: "Authentication required. Please provide a valid bearer token."
            meta:
              requestId: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
              timestamp: "2026-01-03T10:30:00Z"
    
    Forbidden:
      description: Forbidden - User does not have permission to access this resource
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "FORBIDDEN"
              message: "You do not have permission to access this resource"
            meta:
              requestId: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
              timestamp: "2026-01-03T10:30:00Z"
    
    NotFound:
      description: Not Found - Resource does not exist
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "NOT_FOUND"
              message: "The requested resource was not found"
            meta:
              requestId: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
              timestamp: "2026-01-03T10:30:00Z"
    
    Conflict:
      description: Conflict - Resource already exists or ETag mismatch
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            duplicate:
              summary: Duplicate resource
              value:
                error:
                  code: "CONFLICT"
                  message: "A resource with this identifier already exists"
                meta:
                  requestId: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
                  timestamp: "2026-01-03T10:30:00Z"
            concurrency:
              summary: ETag mismatch (concurrency conflict)
              value:
                error:
                  code: "PRECONDITION_FAILED"
                  message: "The resource has been modified by another request. Please retrieve the latest version and retry."
                meta:
                  requestId: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
                  timestamp: "2026-01-03T10:30:00Z"
            hasChildren:
              summary: Cannot delete resource with children
              value:
                error:
                  code: "HAS_CHILDREN"
                  message: "Cannot delete resource because it has child entities. Use ?cascade=true to delete recursively."
                meta:
                  requestId: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
                  timestamp: "2026-01-03T10:30:00Z"
    
    InternalServerError:
      description: Internal Server Error - An unexpected error occurred
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "INTERNAL_ERROR"
              message: "An unexpected error occurred while processing your request"
            meta:
              requestId: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
              timestamp: "2026-01-03T10:30:00Z"
  
  # ==========================================
  # Security Schemes
  # ==========================================
  
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT bearer token authentication (currently stubbed with hardcoded user context)
